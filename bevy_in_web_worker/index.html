<html lang="en">

<head>
  <meta charset="UTF-8" />
  <style>
    body {
      background: linear-gradient(135deg,
          white 0%,
          white 49%,
          black 49%,
          black 51%,
          white 51%,
          white 100%) repeat;
      background-size: 20px 20px;
      font-size: 14px;
    }

    a {
      color: darkcyan;
    }

    div {
      margin: 0;
      padding: 0;
    }

    button {
      height: 30px;
    }

    #page {
      display: block;
      margin: 0 auto;
      padding: 0px;
      width: 1200px;
    }

    #nav {
      height: 124px;
      width: 100%;
    }

    #container {
      display: flex;
      position: relative;
      width: 100%;
      height: 600px;
    }

    #container div {
      width: 50%;
      height: 100%;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background-color: gainsboro;
    }

    #rotate {
      width: 33px;
      height: 33px;
      border: 1px solid red;
      transform-origin: center;
    }

    .child {
      flex: 1;
      height: 33px;
    }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      animation: colorChange 1s infinite;
    }

    @keyframes colorChange {

      0%,
      100% {
        color: gray;
      }

      50% {
        color: black;
      }
    }
  </style>
  <title>Web Worker</title>
</head>

<body>
  <div id="page">
    <div id="nav">
      <div style="display: flex; height: 33px; background-color: #f5f5f5; line-height: 33px;">
        <div class="child">
          <div id="rotate"></div>
        </div>
        <div class="child" style="flex: 2"> 主线程卡顿指示器</div>
        <a class="child" style="flex: 12; text-align: right;"
          href="https://github.com/jinleili/bevy-in-web-worker/blob/main/public/worker.js">查看源码</a>

      </div>
      <p> Ray Pick 结果(唯一标识)：<span id="pick-list" style="color: darkgoldenrod;"></span></p>
      <div>
        <input type="number" id="numberInput" placeholder="输入数字(0-200之间)" />

        <button id="jank">开始阻塞主线程</button>
        <button id="stop-jank">停止阻塞</button>
      </div>
    </div>

    <div style="display:flex; height: 33px; font-weight: 500; text-align: center;">
      <div class="child" style="color: crimson; line-height: 33px; background-color:darkgray;">主线程 renderer</div>
      <div class="child" style="color:forestgreen;line-height: 33px; background-color:azure;">Woker 线程 renderer</div>
    </div>
    <div id="container">
      <div id="main-thread-container">
        <canvas id="main-thread-canvas" raw-window-handle="1"></canvas>
      </div>
      <div id="worker-thread-container">
        <canvas id="worker-thread-canvas" raw-window-handle="2"></canvas>
      </div>
    </div>

    <div id="loading">Wasm 加载中，没开 VPN 的情况下可能会比较慢...</div>

  </div>

  <script type="module" src="./index.js"></script>

  <script>
    // 主线程卡顿指示器
    const jankIndicator = document.getElementById('rotate');
    let rotation = 0;

    function animate() {
      rotation += 2;
      jankIndicator.style.transform = `rotate(${rotation}deg)`;
      requestAnimationFrame(animate);
    }

    animate();

    // 模拟主线程阻塞
    let blockTime = 32;
    let needsStop = true;
    let frameCount = 0;

    const numberInput = document.getElementById('numberInput');
    numberInput.addEventListener('input', function () {
      let inputValue = parseInt(numberInput.value);

      if (inputValue > 200) {
        alert('请输入 0 到 200 之间的数字');
        numberInput.value = '32';
        blockTime = 32;
      } else {
        blockTime = inputValue;
      }
    });

    document.getElementById("jank").addEventListener("click", () => {
      needsStop = false;
      frameCount = 0;
      jankFn();
    });

    document.getElementById("stop-jank").addEventListener("click", () => {
      needsStop = true;
    });

    function jankFn() {
      if (needsStop === false) {
        // 当阻塞时长 >= 一帧的时长时，连续阻塞主线程就完全卡死了
        if (frameCount % 2 === 0) {
          const start = performance.now();
          while (performance.now() - start < blockTime) { }
        }
        requestAnimationFrame(jankFn);
      }
    }
  </script>
</body>

</html>