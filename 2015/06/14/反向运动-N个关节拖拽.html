<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="author" content="李金磊" >

    <title>反向运动（n个关节拖拽）</title>

    

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/bower_components/normalize.css/normalize.css" >

    <script src="/javascripts/utils.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>
  <body>
    <div class="wrapper">

      <!-- 背景圆角 -->
      <div id="fixedRadiusCornerBg">
        <div id="fixedRadiusCornerBg_left" class="radiusCornerBg">
        </div>
        <div id="fixedRadiusCornerBg_right" class="radiusCornerBg">
        </div>
      </div>

      <header>
        <a href="/">
        <img id="round" style="" src="/images/avatar.png" />
        <p style="color:#252525;font-size:22px; font-style:bold;">李金磊的 Playground</p>
        <p style="color:#555555;text-align:left">「Less talk, more coding, professional made wheels.」</p>
      </a>
        <p class="view">


          <div id="tags">
            <h3>Tags：</h3>
            
    <a href="/tag/Canvas/index.html"> Canvas</a>

    <a href="/tag/Javascript/index.html"> Javascript</a>

    <a href="/tag/动效/index.html"> 动效</a>

    <a href="/tag/SVG/index.html"> SVG</a>

    <a href="/tag/Bezier/index.html"> Bezier</a>

    <a href="/tag/图形图像/index.html"> 图形图像</a>

    <a href="/tag/WebGL/index.html"> WebGL</a>

    <a href="/tag/流体模拟/index.html"> 流体模拟</a>

    <a href="/tag/运动学/index.html"> 运动学</a>

          </div>

      </header>

      <section id="content">
        <div>
  <h2>反向运动（n个关节拖拽）</h2>
  <p class="time">14 Jun 2015</p>

  <p><b>Demo:</b>通过鼠标拖拽N个关节</p>
  <canvas id="canvas">
        当前的浏览器不支持canvas, canvas是HTML5里才有的标签，主要用于图形绘制操作
  </canvas>

  <p><b>实现代码</b></p>
  <p>定义关节对象</p>
  <pre id="pre" class="prettyprint">
function createAJoint(ctx) {
  return {
    origin: {x:0, y:0},//原点
    rotateAngle: 0,
    nearPin: {x:0, y:0},//近端节点
    farPin: {x:0, y:110},//远端节点
    pinRadius: 7,
    width: 20,
    height: 80,

    //返回下一个关节需要的节点
    getPin: function() {
      var distance = (this.height - this.width);
      var pointX = this.origin.x - Math.sin(this.rotateAngle) * distance  ;
      var pointY = Math.cos(this.rotateAngle) * distance + this.origin.y;
      return {x: pointX , y: pointY};
    },

    drag: function(x, y) {
      var angle = Math.atan2(y-this.origin.y, x-this.origin.x);
      //数学坐标与屏幕坐标的差异；
      angle -= Math.PI/2;
      //要移动的斜边距离
      var axisX = x - this.origin.x;
      var axisY = y - this.origin.y
      var edge = Math.sqrt(axisX*axisX + axisY*axisY) - this.farPin.y;

      //计算新的坐标原点, 需要加上上个原点的位置
      var newX = -Math.sin(angle) * edge + this.origin.x;
      var newY = Math.cos(angle) * edge + this.origin.y ;
      this.draw(newX, newY, angle);
    },

    draw: function(px, py, angle) {
      ctx.save();
      //因为绘制的是竖向的关节，旋转角度是从横向X轴开始算的
      this.rotateAngle = angle;
      this.origin.x = px;
      this.origin.y = py;
      this.farPin.y = this.height - this.width;

      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#009999";

      ctx.translate(px, py);
      ctx.rotate(this.rotateAngle);

      ctx.beginPath();
      ctx.rect(-this.width/2,-this.width/2, this.width, this.height);
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "#ff0000";
      ctx.arc(this.nearPin.x, this.nearPin.y, this.pinRadius, 0, 2 * Math.PI, false);
      ctx.fill();

      ctx.fillStyle = "#00ff00";
      ctx.arc(this.farPin.x, this.farPin.y, this.pinRadius, 0, 2 * Math.PI, false);
      ctx.fill();

      ctx.restore();
    }
  }
}
  </pre>
  <p>绘制到屏幕</p>
  <pre  class="prettyprint">
function update(canX, canY) {
  ctx.clearRect(0,0, canvasWidth, canvasHeight);
  drawCanvasBackground();
  var tempJoint;
  for (var i=joints.length-1; i>=0; i--) {
    var joint = joints[i];
    if (tempJoint) {
      joint.drag(tempJoint.origin.x, tempJoint.origin.y);
    } else {
      joint.drag(canX, canY);
    }
    tempJoint = joint;
  }
}
  </pre>

  <script src="/javascripts/draw.js"></script>

  <script type="text/javascript">
  ctx.canvas.height  = 380  ;
  canvasHeight = canvas.offsetHeight;

  //监听鼠标事件
  canvas.addEventListener("mouseup", mouseUp, false);

  function fire(x, y) {
    canvas.addEventListener("mousemove", mouseMove, false);
  }

  function mouseUp() {
    canvas.removeEventListener("mousemove", mouseMove, false);
  }

  var mouseMove = function () {
    var e = event;
    var rect = canvas.getBoundingClientRect();
    var canX = e.pageX - rect.left;
    var canY = e.pageY - rect.top;
    update(canX, canY);
  }

  function update(canX, canY) {
    ctx.clearRect(0,0, canvasWidth, canvasHeight);
    drawCanvasBackground();
    var tempJoint;
    for (var i=joints.length-1; i>=0; i--) {
      var joint = joints[i];
      if (tempJoint) {
        joint.drag(tempJoint.origin.x, tempJoint.origin.y);
      } else {
        joint.drag(canX, canY);
      }
      tempJoint = joint;
    }
  }

  //创建一个5关节的数组
  var joints = new Array();

  function init() {
    setCanvasScaleIfNeeds();
    drawCanvasBackground();
    var lastJoint;
    for (var i=0; i<5; i++) {
      var joint = createAJoint(ctx);
      if (lastJoint) {
        var pin = lastJoint.getPin();
        joint.draw(pin.x, pin.y, 0);
      }
      else {
        joint.draw(centerX, 30, 0);
      }
      joints[i] = joint;
      lastJoint = joint;
    }
  }

  function enterFrame() {

  }

  function createAJoint(ctx) {
    return {
      origin: {x:0, y:0},//原点
      rotateAngle: 0,
      nearPin: {x:0, y:0},//近端节点
      farPin: {x:0, y:110},//远端节点
      pinRadius: 7,
      width: 20,
      height: 80,

      //返回下一个关节需要的节点
      getPin: function() {
        var distance = (this.height - this.width);
        var pointX = this.origin.x - Math.sin(this.rotateAngle) * distance  ;
        var pointY = Math.cos(this.rotateAngle) * distance + this.origin.y;
        return {x: pointX , y: pointY};
      },

      drag: function(x, y) {
        var angle = Math.atan2(y-this.origin.y, x-this.origin.x);
        //数学坐标与屏幕坐标的差异；
        angle -= Math.PI/2;
        //要移动的斜边距离
        var axisX = x - this.origin.x;
        var axisY = y - this.origin.y
        var edge = Math.sqrt(axisX*axisX + axisY*axisY) - this.farPin.y;

        //计算新的坐标原点, 需要加上上个原点的位置
        var newX = -Math.sin(angle) * edge + this.origin.x;
        var newY = Math.cos(angle) * edge + this.origin.y ;
        this.draw(newX, newY, angle);
      },

      draw: function(px, py, angle) {
        ctx.save();
        //因为绘制的是竖向的关节，旋转角度是从横向X轴开始算的
        this.rotateAngle = angle;
        this.origin.x = px;
        this.origin.y = py;
        this.farPin.y = this.height - this.width;

        ctx.save();
        ctx.translate(px, py);
        ctx.rotate(this.rotateAngle);

        ctx.fillStyle = "#ffffff";
        ctx.strokeStyle = "#009999";

        ctx.beginPath();
        ctx.rect(-this.width/2,-this.width/2, this.width, this.height);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = "#ff0000";
        ctx.beginPath();
        ctx.arc(this.nearPin.x, this.nearPin.y, this.pinRadius, 0, 2 * Math.PI, false);
        ctx.fill();

        ctx.fillStyle = "#00ff00";
        ctx.beginPath();
        ctx.arc(this.farPin.x, this.farPin.y, this.pinRadius, 0, 2 * Math.PI, false);
        ctx.fill();

        ctx.restore();
      }
    }
  }

  init();
  </script>

</div>

      </section>

      <!-- 文字淡出 -->
      <!-- <div id="fadeoutContainer">
        <div id="topFadeoutCorner">
        </div>

      </div> -->
      <svg width="0" height="0">
        <defs>
          <clipPath id="clip3">
             <rect width="568" height="426" rx="85.2" ry="85.2"></rect>
          </clipPath>
          <clipPath id="clip4">
              <ellipse cx="284" cy="213" rx="284" ry="213"></ellipse>
          </clipPath>
          <filter id="filter2">
            <feGaussianBlur stdDeviation="10"></feGaussianBlur>
          </filter>
          <filter id="filter">
            <feGaussianBlur stdDeviation="0.03"></feGaussianBlur>
          </filter>
          <filter id="filter2">
            <feGaussianBlur stdDeviation="5"></feGaussianBlur>
          </filter>
          <linearGradient id="gradient" x1="0" y1="00%" x2="0" y2="100%">
            <stop stop-color="black" offset="0"></stop>
            <stop stop-color="white" offset="1"></stop>
          </linearGradient>
          <clipPath id="clipping4">
            <rect width="5680" height="2" rx="85.2" ry="85.2"></rect>
          </clipPath>
        </defs>
      </svg>
      <footer>
        <p><small>contact me：grenlight@icloud.com</small></p>
      </footer>
    </div>
    <script src="/javascripts/scale.fix.js"></script>
<script src="/javascripts/prettify/run_prettify.js"></script>
<link rel="stylesheet" href="/stylesheets/code-prettify-sunburst.css">

</script>
  </body>
</html>
