<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="author" content="李金磊" >

    <title>任意多个控制点的 Bezier 路径动画</title>

    

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/bower_components/normalize.css/normalize.css" >

    <script src="/javascripts/utils.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>
  <body>
    <div class="wrapper">

      <!-- 背景圆角 -->
      <div id="fixedRadiusCornerBg">
        <div id="fixedRadiusCornerBg_left" class="radiusCornerBg">
        </div>
        <div id="fixedRadiusCornerBg_right" class="radiusCornerBg">
        </div>
      </div>

      <header>
        <a href="/">
        <img id="round" style="" src="/images/avatar.png" />
        <p style="color:#252525;font-size:22px; font-style:bold;">李金磊的 Playground</p>
        <p style="color:#555555;text-align:left">「Less talk, more coding, professional made wheels.」</p>
      </a>
        <p class="view">


          <div id="tags">
            <h3>Tags：</h3>
            
    <a href="/tag/Canvas/index.html"> Canvas</a>

    <a href="/tag/Javascript/index.html"> Javascript</a>

    <a href="/tag/动效/index.html"> 动效</a>

    <a href="/tag/SVG/index.html"> SVG</a>

    <a href="/tag/Bezier/index.html"> Bezier</a>

    <a href="/tag/图形图像/index.html"> 图形图像</a>

    <a href="/tag/WebGL/index.html"> WebGL</a>

    <a href="/tag/流体模拟/index.html"> 流体模拟</a>

    <a href="/tag/运动学/index.html"> 运动学</a>

          </div>

      </header>

      <section id="content">
        <div>
  <h2>任意多个控制点的 Bezier 路径动画</h2>
  <p class="time">20 Aug 2015</p>

  <p><b>Demo:</b>一辆沿着曲线走的小汽车</p>
  <p>拖拽灰色折线的顶点可以调整行车路径</p>
<div style="height:380px;width:100%;display:block">
  <canvas id="canvas" style="position:absolute;z-index:100">
  </canvas>
  <canvas id="canvas1" style="position:absolute;z-index:110">
  </canvas>
</div>
  <p style="clear:both;"></p>

  <script src="/javascripts/draw.js"></script>
  <script src="/javascripts/bezier.js"></script>
  <script src="/javascripts/bezierAnimator.js"></script>
  <script src="/javascripts/vehicle.js"></script>

  <script type="text/javascript">
  var cvs1 = getCanvasByID("canvas1");
  var car = vehicle(cvs1.context);

  var cvs = getCanvasByID("canvas");
  // var controlPoints = [{x:50, y:50}, {x:100, y:330}, {x:200, y:250}, {x:300, y:100}, {x:450, y:130}, {x:580, y:50}];
  var controlPoints = [{x:10, y:150}, {x:100, y:100}, {x:200, y:350}, {x:300, y:250}, {x:450, y:130}, {x:550, y:170}, {x:620, y:150}];
  //当前拖动的控制点索引
  var currentDragIndex;
  //监听鼠标事件
  cvs1.element.addEventListener("mouseup", mouseUp, false);
  cvs1.element.addEventListener("mousedown", mouseDown, false);

  function fire(x, y) {
    var offset = 10;
    for (var i=0; i<controlPoints.length; i++) {
      var controlPoint = controlPoints[i];
      if (x<(controlPoint.x+offset) && x>(controlPoint.x-offset)
    && y<(controlPoint.y+offset) && y>(controlPoint.y-offset)) {
        currentDragIndex = i;
        cvs1.element.addEventListener("mousemove", mouseMove, false);
        break;
      }
    }
  }

  function mouseUp() {
    cvs1.element.removeEventListener("mousemove", mouseMove, false);
  }

  var mouseMove = function () {
    var e = event;
    var rect = canvas.getBoundingClientRect();
    var canX = e.pageX - rect.left;
    var canY = e.pageY - rect.top;
    controlPoints[currentDragIndex] = {x:canX, y:canY};
    updateDisplay();
    glBezierAnimate(controlPoints, 2, driveCar);
  }

  function updateDisplay() {
    cvs.context.clearRect(0,0, canvasWidth, canvasHeight);
    drawCanvasBackground(cvs.context);
    cvs.context.strokeStyle = "#ffffff";
    cvs.context.lineWidth = 2;
    glDrawBezierCurve(controlPoints, cvs.context, true);
  }

  function driveCar(targetX, targetY, targetAngle) {
    cvs1.context.clearRect(0,0, canvasWidth, canvasHeight);

    car.update(targetX, targetY, targetAngle);
  }
  updateDisplay();
  glBezierAnimate(controlPoints, 2, driveCar);
  </script>

  <p><b>实现代码</b></p>
  <pre id="pre" class="prettyprint">
[/*
Bezier曲线动画实现步骤
- 计算出曲线绘制点的坐标及角度,将其保存到数组中；
- 执行animateFunc
*/
var bezierFramePoints = new Array();
var bezierFrameIndex = 0;
var _animateFunc;
var bezierFrameHandle;

function excuteBezierAnimation() {
  if (bezierFrameIndex < bezierFramePoints.length) {
    var frameData = bezierFramePoints[bezierFrameIndex];
    _animateFunc(frameData.x, frameData.y, frameData.angle);
    bezierFrameIndex ++;
  }
  else {
    bezierFrameIndex = 0;
  }
  bezierFrameHandle = window.requestAnimationFrame(excuteBezierAnimation);
}

function glBezierAnimate(points, duration, animateFunc) {
  _animateFunc = animateFunc;
  var firstP = points[0];
  //为保证采样足够，先计算控制多边形的总的边长，然后定义步长为 1/总边长
  var adgeArr = new Array();
  var totalStep = calculateControlEdge(points, adgeArr);
  //预先计算好基于步长的各边的x,y的增量
  var step = 1.0/totalStep;
  var drawX, drawY;
  bezierFramePoints = [];
  for (var i=0; i< totalStep; i+=5) {
    var ps = calculateReferenceLine(points, adgeArr, i);
    //计算绘制点的斜边长 及 与X轴的夹角
    var lengthX = ps[1].x - ps[0].x;
    var lengthY = ps[1].y - ps[0].y;

    var sideLength0 = Math.sqrt(lengthX*lengthX + lengthY*lengthY) ;
    var sideLength1 = sideLength0  * (step*i);
    drawX = ps[0].x + (lengthX/sideLength0) * sideLength1;
    drawY = ps[0].y + (lengthY/sideLength0) * sideLength1;
    bezierFramePoints.push({x:drawX, y:drawY, angle:Math.atan2(lengthY, lengthX)});
  }
  window.cancelAnimationFrame(bezierFrameHandle);
  excuteBezierAnimation();]
  </pre>
</div>

      </section>

      <!-- 文字淡出 -->
      <!-- <div id="fadeoutContainer">
        <div id="topFadeoutCorner">
        </div>

      </div> -->
      <svg width="0" height="0">
        <defs>
          <clipPath id="clip3">
             <rect width="568" height="426" rx="85.2" ry="85.2"></rect>
          </clipPath>
          <clipPath id="clip4">
              <ellipse cx="284" cy="213" rx="284" ry="213"></ellipse>
          </clipPath>
          <filter id="filter2">
            <feGaussianBlur stdDeviation="10"></feGaussianBlur>
          </filter>
          <filter id="filter">
            <feGaussianBlur stdDeviation="0.03"></feGaussianBlur>
          </filter>
          <filter id="filter2">
            <feGaussianBlur stdDeviation="5"></feGaussianBlur>
          </filter>
          <linearGradient id="gradient" x1="0" y1="00%" x2="0" y2="100%">
            <stop stop-color="black" offset="0"></stop>
            <stop stop-color="white" offset="1"></stop>
          </linearGradient>
          <clipPath id="clipping4">
            <rect width="5680" height="2" rx="85.2" ry="85.2"></rect>
          </clipPath>
        </defs>
      </svg>
      <footer>
        <p><small>contact me：grenlight@icloud.com</small></p>
      </footer>
    </div>
    <script src="/javascripts/scale.fix.js"></script>
<script src="/javascripts/prettify/run_prettify.js"></script>
<link rel="stylesheet" href="/stylesheets/code-prettify-sunburst.css">

</script>
  </body>
</html>
